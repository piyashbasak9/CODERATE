{% extends 'base.html' %}
{% block content %}
<section class="section">
  <div class="container">
    <!-- Profile Header Card -->
    <div class="card mb-6">
      <div class="card-image">
        {% if profile.profile_picture %}
          <figure class="image is-128x128 is-centered mt-5">
            <img class="is-rounded" src="{{ profile.profile_picture.url }}" alt="Profile picture">
          </figure>
        {% endif %}
      </div>
      <div class="card-content has-text-centered">
        <h1 class="title is-2 mb-2">{{ profile_user.username }}</h1>
        {% if profile.codeforces_handle %}
          <p class="subtitle is-5 mb-4">
            <span class="icon-text">
              <span class="icon is-small">
                <i class="fas fa-code"></i>
              </span>
              <span>{{ profile.codeforces_handle }}</span>
            </span>
          </p>
        {% endif %}
        
        {% if cf_data %}
          <div class="box has-background-info-light mb-4">
            <p><strong>Rating:</strong> <span class="has-text-weight-bold has-text-info">{{ cf_data.rating }}</span> | 
               <strong>Max:</strong> {{ cf_data.maxRating }}</p>
            <p><strong>Rank:</strong> <span class="tag has-text-weight-bold is-medium">{{ cf_data.rank }}</span> | 
               <strong>Max Rank:</strong> {{ cf_data.maxRank }}</p>
          </div>
        {% elif profile.rating %}
          <div class="box has-background-success-light mb-4">
            <p><strong>Rating:</strong> {{ profile.rating }} | <strong>Max:</strong> {{ profile.max_rating }}</p>
          </div>
        {% endif %}
        
        {% if profile.bio %}
          <div class="content mb-4">
            <h3 class="subtitle has-text-weight-semibold mb-3">About Me</h3>
            <p>{{ profile.bio|linebreaks }}</p>
          </div>
        {% endif %}
      </div>
    </div>

    {% if user.username == profile_user.username %}
      <!-- Edit Profile Section -->
      <div class="card mb-6">
        <div class="card-header">
          <p class="card-header-title">Edit Profile</p>
        </div>
        <div class="card-content">
          <form method="post" enctype="multipart/form-data">{% csrf_token %}
            {{ form.as_p }}
            <div class="field is-grouped">
              <div class="control">
                <button class="button is-primary is-medium">Save Changes</button>
              </div>
            </div>
          </form>
        </div>
      </div>
    {% else %}
      <div class="notification is-info">
        <strong>You can only edit your own profile.</strong>
      </div>
    {% endif %}

    {% if user_problems %}
      <!-- Problems Table Section -->
      <div class="card">
        <div class="card-header">
          <p class="card-header-title">Problems by {{ profile_user.username }}</p>
        </div>
        <div class="card-content">
          <div class="table-container">
            <table class="table is-fullwidth is-striped is-hoverable is-narrow">
              <thead>
                <tr>
                  <th><abbr title="Problem Name">Name</abbr></th>
                  <th><abbr title="Problem ID">ID</abbr></th>
                  <th><abbr title="Tags">Tags</abbr></th>
                  <th><abbr title="Average Rating">Avg Rating</abbr></th>
                  <th><abbr title="Your Rating">Your Rating</abbr></th>
                  <th><abbr title="Codeforces Link">Link</abbr></th>
                  <th><abbr title="Status">Status</abbr></th>
                </tr>
              </thead>
              <tbody>
                {% for p in user_problems %}
                  <tr>
                    <td>
                      <a href="{% url 'problem_detail' p.problem_id %}" class="has-text-weight-semibold">{{ p.name }}</a>
                    </td>
                    <td class="is-monospace">{{ p.problem_id }}</td>
                    <td>
                      {% for t in p.tags.all %}
                        <span class="tag is-info is-light is-small mr-1">{{ t.name }}</span>
                      {% empty %}
                        <span class="tag is-light is-small">No tags</span>
                      {% endfor %}
                    </td>
                    <td>{{ p.average_rating|floatformat:0 }}</td>
                    <td>
                      {% if user.is_authenticated %}
                        <div class="field has-addons">
                          <div class="control">
                            <div class="select is-small">
                              <select name="value">
                                {% for val in rating_choices %}
                                  <option value="{{ val }}" {% if p.user_rating == val %}selected{% endif %}>{{ val }}</option>
                                {% endfor %}
                              </select>
                            </div>
                          </div>
                          <div class="control">
                            <button class="button is-small is-info" form="rate-{{ p.problem_id }}">Save</button>
                          </div>
                        </div>
                        <form id="rate-{{ p.problem_id }}" method="post" action="{% url 'rate_problem' p.problem_id %}" style="display:inline;">
                          {% csrf_token %}
                          <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        </form>
                      {% else %}
                        <a href="{% url 'login' %}" class="button is-small is-light">Login to rate</a>
                      {% endif %}
                    </td>
                    <td>
                      <a class="button is-small is-link is-light" href="https://codeforces.com/problemset/problem/{{ p.contest_id }}/{{ p.index }}" target="_blank" rel="noopener">
                        <span class="icon is-small">
                          <i class="fas fa-external-link-alt"></i>
                        </span>
                        <span>CF</span>
                      </a>
                    </td>
                    <td>
                      {% if user.is_authenticated %}
                        <div class="buttons">
                          <form method="post" action="{% url 'mark_problem' p.problem_id %}" class="is-inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="pending">
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="button is-small {% if p.user_status == 'pending' %}is-warning is-selected{% else %}is-light{% endif %}">
                              Pending
                            </button>
                          </form>
                          <form method="post" action="{% url 'mark_problem' p.problem_id %}" class="is-inline">
                            {% csrf_token %}
                            <input type="hidden" name="status" value="solved">
                            <input type="hidden" name="next" value="{{ request.get_full_path }}">
                            <button type="submit" class="button is-small {% if p.user_status == 'solved' %}is-success is-selected{% else %}is-light{% endif %}">
                              Solved
                            </button>
                          </form>
                        </div>
                      {% else %}
                        <a href="{% url 'login' %}" class="button is-small is-light">Login</a>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}
